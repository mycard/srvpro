<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SRVPro Update Dashboard</title>
<link rel="stylesheet" href="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-y/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
<link href="/static/style.css" rel="stylesheet">
</head>
<body>
<header class="container">
    <h1 class="title">SRVPro 更新控制台</h1>
</header>
<div class="container">
    <div class="row grid">
        <div class="col-lg-2">
            <select class="form-control" id="http">
                <option value ="http">HTTP</option>
                <option value ="https">HTTPS</option>
            </select>
        </div>
        <div class="col-lg-2">
            <input type="text" class="form-control" id="ip" value="" placeholder="IP">
        </div>
        <div class="col-lg-2">
            <input type="text" class="form-control" id="port" value="" placeholder="Port">
        </div>
        <div class="col-lg-2">
            <input type="username" class="form-control" id="username" value="" placeholder="Username">
        </div>
        <div class="col-lg-2">
            <input type="password" class="form-control" id="password" value="" placeholder="Password">
        </div>
        <div class="col-lg-2">
            <button class="btn btn-default" id="login_button">登陆</button>
            <button class="btn btn-default" id="clear_button">清屏</button>
        </div>
    </div>
    <!--div class="row grid buttons hidden">
        <div class="col-lg-2">
            <button class="btn btn-default" disabled title="暂未实装" action="">复制临时服务端</button>
        </div>
        <div class="col-lg-2">
            <button class="btn btn-default" disabled title="暂未实装" action="">更新临时服务端</button>
        </div>
        <div class="col-lg-2">
            <button class="btn btn-default" disabled title="暂未实装" action="">编译临时服务端</button>
        </div>
        <div class="col-lg-2">
            <button class="btn btn-default" disabled title="暂未实装" action="">替换主要服务端</button>
        </div>
        <div class="col-lg-2">
            <button class="btn btn-default" disabled title="暂未实装" action="">更新主要服务端数据库和脚本</button>
        </div>
    </div-->
    <div class="row grid buttons hidden">
        <div class="col-lg-2">
            <button class="btn btn-default" action="fetch_datas">下载最新网页</button>
        </div>
        <div class="col-lg-2">
            <button class="btn btn-default" action="load_db">读取数据库</button>
        </div>
        <div class="col-lg-2">
            <button class="btn btn-default" action="make_changelog">生成更新记录</button>
        </div>
        <div class="col-lg-2">
            <button class="btn btn-default" action="make_more_changelog">更多更新记录</button>
        </div>
        <div class="col-lg-2">
            <button class="btn btn-default" action="update_changelog">写入更新记录</button>
        </div>
        <div class="col-lg-2">
            <button class="btn btn-default" action="push_datas">上传到网页</button>
        </div>
    </div>
    <div class="row buttons hidden">
        <div class="col-lg-12">
<textarea class="form-control" rows="20" id="message" value="" placeholder="update message"></textarea>
<textarea class="hidden" id="message-head" value="" placeholder="update message">服务器升级，与官方版同步，修复一些BUG。

绝大部分修改来自于YGOPro官方开发者和爱好者的贡献。你可以在[GitHub](https://github.com/moecube/ygopro/tree/server)查看修改详情。

</textarea>
<textarea class="hidden" id="message-body" value="" placeholder="update message">新增卡片：
-   无

卡片更改：
-   无

</textarea>
<textarea class="hidden" id="message-other" value="" placeholder="update message">其他更改：
-   无</textarea>
        
        </div>
    </div>
</div>
<div class="container">
    <hr>
    <div class="row">
        <div class="col-lg-12">
            <ul id="output" class="list-unstyled">

            </ul>
        </div>
    </div>
</div>

<script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-y/jquery/2.2.4/jquery.min.js" integrity="sha384-rY/jv8mMhqDabXSo+UCggqKtdmBfd3qC2/KvyTDNQ6PcUJXaxK1tMepoQda4g5vB" crossorigin="anonymous"></script>
<script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-y/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>
<script>
var ip, port, password;

$(function(){
    $("body").tooltip({selector: "[data-toggle='tooltip']"});
    
    $("#login_button").click(login);
    $("#clear_button").click(clear);
    
    $(".buttons button").click(function(){openapi($(this).attr("action"))});

    
    var params=parseQueryString();
    $("#ip").val(params["ip"]);
    $("#port").val(params["port"]);
    $("#password").val(params["password"]);
	$("#username").val(params["username"]);
	

    $("#message").val($("#message-head").val()+$("#message-body").val()+$("#message-other").val());
});

function parseQueryString() {
    //http://stackoverflow.com/questions/523266/how-can-i-get-a-specific-parameter-from-location-search
    var str = window.location.search;
    var objURL = {};
    str.replace(
        new RegExp( "([^?=&]+)(=([^&]*))?", "g" ),
        function( $0, $1, $2, $3 ){
            objURL[ $1 ] = $3;
        }
    );
    return objURL;
}

function login() {
    ip=$("#ip").val();
    port=$("#port").val();
    password=$("#password").val();
	username=$("#username").val();
    var es = new EventSource($("#http").val() + "://"+ip+":"+port+"/api/msg?username="+username+"&password="+password);
    es.onmessage = function(e) {
        var data_li = $('<li>'+ e.data +'</li>');
        data_li.appendTo($("#output"));
        
        if (e.data=="已连接。") {
            $(".row.buttons").removeClass("hidden");
        }
        else {
            try {
                var resJSON = JSON.parse(e.data);
                if (resJSON.type=="changelog") {
                    $("#message").val($("#message-head").val()+ resJSON.changelog.join("\n") +$("#message-other").val());
                }
            }
            catch (e) {

            }
        }
    };
    es.onerror = function(e) {
        $(".row.buttons").addClass("hidden");
        data_li = $('<li>已断开。</li>');
        data_li.appendTo($("#output"));
        //alert("连接断开！");
        es.close();
    };
}

function clear() {
    $("#output").html(" ");
}

function openapi(api) {
    $.getJSON($("#http").val() + "://"+ip+":"+port+"/api/"+ api +"?username="+username+"&password="+password+"&message="+$("#message").val().replace(/\n/g,"！换行符！")+"&callback=?", function(data) {
        var data_li = $('<li>'+ data.message +'</li>');
        data_li.appendTo($("#output"));
    });
}
</script>

</body>
</html>
